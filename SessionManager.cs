using System;using System.IO;using System.Text.Json;namespace TimelapseCapture{public class SessionInfo{public string? Name{get;set;}public int IntervalSeconds{get;set;}public int VideoFps{get;set;}public DateTime StartTime{get;set;}public bool Active{get;set;}=true;public long FramesCaptured{get;set;}=0;}public static class SessionManager{private const string SessionFileName="session.json";public static string? FindActiveSession(string capturesRoot){if(string.IsNullOrEmpty(capturesRoot)||!Directory.Exists(capturesRoot))return null;foreach(var dir in Directory.GetDirectories(capturesRoot)){var sessionFile=Path.Combine(dir,SessionFileName);if(File.Exists(sessionFile)){try{var json=File.ReadAllText(sessionFile);var s=JsonSerializer.Deserialize<SessionInfo>(json);if(s!=null&&s.Active)return dir;}catch{}}}return null;}public static SessionInfo? LoadSession(string sessionFolder){var sessionFile=Path.Combine(sessionFolder,SessionFileName);if(!File.Exists(sessionFile))return null;try{var json=File.ReadAllText(sessionFile);return JsonSerializer.Deserialize<SessionInfo>(json);}catch{return null;}}public static void SaveSession(string sessionFolder,SessionInfo info){var sessionFile=Path.Combine(sessionFolder,SessionFileName);var opts=new JsonSerializerOptions{WriteIndented=true};var json=JsonSerializer.Serialize(info,opts);File.WriteAllText(sessionFile,json);}public static string CreateNewSession(string capturesRoot,int intervalSeconds,int videoFps){Directory.CreateDirectory(capturesRoot);var name=$"timelapse_{DateTime.Now:yyyyMMdd_HHmmss}";var folder=Path.Combine(capturesRoot,name);Directory.CreateDirectory(folder);var info=new SessionInfo{Name=name,IntervalSeconds=intervalSeconds,VideoFps=videoFps,StartTime=DateTime.UtcNow,Active=true,FramesCaptured=0};SaveSession(folder,info);return folder;}public static void MarkSessionInactive(string sessionFolder){var info=LoadSession(sessionFolder);if(info==null)return;info.Active=false;SaveSession(sessionFolder,info);}public static void IncrementFrameCount(string sessionFolder){var info=LoadSession(sessionFolder);if(info==null)return;info.FramesCaptured++;SaveSession(sessionFolder,info);}}}
